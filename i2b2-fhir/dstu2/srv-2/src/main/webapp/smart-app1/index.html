<!DOCTYPE html>
<html>
 <head>
    <script src="fhir-client.js"></script>
   
 </head>
 <body>
    <h1>Medications for <span id="name"></span></h1>

    <ul id="med_list"></ul>
    <table id="lab_list"></table>


    <script type="text/javascript">
        
        function getName (medication) {
            if (medication.text) {
                return medication.text;
            } else if (medication.coding && medication.coding[0].display) {
                return medication.coding[0].display;
            } else {
                return "Unnamed Medication(TM)";
            }
        }

        FHIR.oauth2.ready(function(smart){
        	var name;
        	var pid;
            var patient = smart.patient;

            patient.read().then(function(pt) {
                if (pt.name && pt.name.length > 0) {
                	name = pt.name[0].given.join(" ") +" "+ pt.name[0].family.join(" ");
            		pid=pt.id;
                } else {
            		name = "anonymous";
            	}
                document.getElementById('name').innerHTML = name;
                
                patient.api.search({type: "MedicationOrder"}).then(function(prescriptions) {
              	   if (prescriptions.data.entry) {
              	       var med_list = document.getElementById('med_list');
                       prescriptions.data.entry.forEach(function(prescription){
                          var med = prescription.resource.medicationCodeableConcept;
                          med_list.innerHTML += "<li> " + getName(med) + "</li>";
                       });
                   }
                });
                
                smart.api.search({type: "Observation", query: {subject :"1000000005"}})
                //patient.api.search({type: "Observation"})
                .then(function(labs) {
               	   if (labs.data.entry) {
               	       var lab_list = document.getElementById('lab_list');
                        labs.data.entry.forEach(function(lab){
                           var labName ;
                           if(lab.hasOwnProperty("resource")
                        		   &&lab.resource.hasOwnProperty("code")
                        		   &&lab.resource.code.hasOwnProperty("coding")
                        		   &&lab.resource.code.coding[0].hasOwnProperty("display")
                        		   ){	
                        	 	labName=lab.resource.code.coding[0].display;
       						}
       					 if(labName==null) {labName="--";}
                           
                           var labValue ;
                           if(lab.hasOwnProperty("resource") 
                        		   && lab.resource.hasOwnProperty("valueCodeableConcept")
                        		   && lab.resource.valueCodeableConcept.hasOwnProperty("coding")
                        		   && lab.resource.valueCodeableConcept.coding[0].hasOwnProperty("display")
                        		   ){	
                       	 		labValue=lab.resource.valueCodeableConcept.coding[0].display;
      						}
                           if(labValue==null
                        		   &&lab.hasOwnProperty("resource") 
                        		   && lab.resource.hasOwnProperty("valueQuantity")
                        		   && lab.resource.valueQuantity.hasOwnProperty("value")
                        		    && lab.resource.valueQuantity.hasOwnProperty("code")
                        		   
                        		   ){	
                        	   labValue=lab.resource.valueQuantity.value+" "+lab.resource.valueQuantity.code;
      						}
                           if(labValue==null) {labValue="--";}
                           
                           //JSON.stringify(lab.resource.valueCodeableConcept,null,4);
                           lab_list.innerHTML += "<li> " + labName + "  "+labValue +"</li>";
                        });
                    }
                 });
            });
        });

    </script>
 </body>
</html>